name: Publish

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    if: |
      github.repository == 'ddv1982/easy-e2e-testing' &&
      (
        (github.event_name == 'release' && github.event.release.target_commitish == github.event.repository.default_branch) ||
        (github.event_name == 'workflow_dispatch' && github.ref_name == github.event.repository.default_branch)
      )
    runs-on: ubuntu-latest
    environment: npm-publish

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org

      - name: Upgrade npm for trusted publishing
        run: npm install --global npm@^11.5.1

      - name: Verify trusted publishing runtime versions
        run: |
          NODE_VERSION="$(node -p "process.versions.node")"
          NPM_VERSION="$(npm --version)"
          export NODE_VERSION NPM_VERSION
          node <<'JS'
          const requiredNode = [22, 14, 0];
          const requiredNpm = [11, 5, 1];

          function parseVersion(raw) {
            return raw.split(".").slice(0, 3).map((part) => Number(part.replace(/[^0-9].*$/, "")) || 0);
          }

          function isLessThan(current, required) {
            for (let i = 0; i < 3; i += 1) {
              if ((current[i] ?? 0) < (required[i] ?? 0)) return true;
              if ((current[i] ?? 0) > (required[i] ?? 0)) return false;
            }
            return false;
          }

          const currentNode = parseVersion(process.env.NODE_VERSION ?? "0.0.0");
          const currentNpm = parseVersion(process.env.NPM_VERSION ?? "0.0.0");

          if (isLessThan(currentNode, requiredNode)) {
            console.error(
              `Node.js ${process.env.NODE_VERSION} is below 22.14.0, which is required for npm trusted publishing.`
            );
            process.exit(1);
          }

          if (isLessThan(currentNpm, requiredNpm)) {
            console.error(
              `npm ${process.env.NPM_VERSION} is below 11.5.1, which is required for npm trusted publishing.`
            );
            process.exit(1);
          }

          console.log(`Trusted publishing prerequisites met (Node ${process.env.NODE_VERSION}, npm ${process.env.NPM_VERSION}).`);
          JS

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium

      - name: Run full test suite
        run: npm test

      - name: Validate package contents
        run: npm pack --dry-run

      - name: Verify npm publish target
        run: |
          PKG_NAME="$(node -p "require('./package.json').name")"
          if npm view "$PKG_NAME" version >/dev/null 2>&1; then
            echo "Package '$PKG_NAME' already exists on npm; continuing with release publish."
          else
            echo "Package '$PKG_NAME' not found on npm; validating name availability for first publish."
            npm run check:npm-name
          fi

      - name: Resolve publish flags
        id: publish_flags
        run: |
          PKG_NAME="$(node -p "require('./package.json').name")"
          if [[ "$PKG_NAME" == @* ]]; then
            echo "args=--provenance --access public" >> "$GITHUB_OUTPUT"
          else
            echo "args=--provenance" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish to npm
        run: npm publish ${{ steps.publish_flags.outputs.args }}
